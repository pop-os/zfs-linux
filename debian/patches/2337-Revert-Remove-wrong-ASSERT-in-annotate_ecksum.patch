From cf232b53d5deb8fba4665ce4fd039b444eb3201a Mon Sep 17 00:00:00 2001
From: Giuseppe Di Natale <dinatale2@llnl.gov>
Date: Wed, 24 Jan 2018 16:19:55 -0800
Subject: [PATCH] Revert "Remove wrong ASSERT in annotate_ecksum"
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 8bit

This reverts commit 093911f1945b5c164a45bb077103283dafdcae0c.

Reviewed-by: Chunwei Chen <tuxoko@gmail.com>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: George Melikov <mail@gmelikov.ru>
Signed-off-by: Giuseppe Di Natale <dinatale2@llnl.gov>
Closes #7079
---
 module/zfs/zfs_fm.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

Index: zfs/module/zfs/zfs_fm.c
===================================================================
--- zfs.orig/module/zfs/zfs_fm.c
+++ zfs/module/zfs/zfs_fm.c
@@ -490,8 +490,7 @@ update_histogram(uint64_t value_arg, uin
 	/* We store the bits in big-endian (largest-first) order */
 	for (i = 0; i < 64; i++) {
 		if (value & (1ull << i)) {
-			if (hist[63 - i] < UINT16_MAX)
-				hist[63 - i]++;
+			hist[63 - i]++;
 			++bits;
 		}
 	}
@@ -649,6 +648,7 @@ annotate_ecksum(nvlist_t *ereport, zio_b
 	if (badabd == NULL || goodabd == NULL)
 		return (eip);
 
+	ASSERT3U(nui64s, <=, UINT16_MAX);
 	ASSERT3U(size, ==, nui64s * sizeof (uint64_t));
 	ASSERT3U(size, <=, SPA_MAXBLOCKSIZE);
 	ASSERT3U(size, <=, UINT32_MAX);
