From da0bbfd99e6ab8e13bb2bbe7bc7ff5aea7f8e402 Mon Sep 17 00:00:00 2001
From: Aron Xu <aron@debian.org>
Date: Sat, 19 Aug 2023 14:33:38 +0800
Subject: [PATCH] Check fpu availability on aarch64

---
 include/os/linux/kernel/linux/simd_aarch64.h | 7 +++++++
 1 file changed, 7 insertions(+)

Index: zfs-linux/include/os/linux/kernel/linux/simd_aarch64.h
===================================================================
--- zfs-linux.orig/include/os/linux/kernel/linux/simd_aarch64.h
+++ zfs-linux/include/os/linux/kernel/linux/simd_aarch64.h
@@ -71,9 +71,16 @@
 #define	ID_AA64PFR0_EL1		sys_reg(3, 0, 0, 1, 0)
 #define	ID_AA64ISAR0_EL1	sys_reg(3, 0, 0, 6, 0)
 
+#if defined(HAVE_KERNEL_FPU)
 #define	kfpu_allowed()		1
 #define	kfpu_begin()		kernel_neon_begin()
 #define	kfpu_end()		kernel_neon_end()
+#else
+#define	kfpu_allowed()		0
+#define	kfpu_begin()		do {} while (0)
+#define	kfpu_end()		do {} while (0)
+#endif
+
 #define	kfpu_init()		(0)
 #define	kfpu_fini()		do {} while (0)
 
