Description: explicitly load the ZFS module via systemd service
Author: Ubuntu developers
Forward: no need
Index: zfs/etc/Makefile.am
===================================================================
--- zfs.orig/etc/Makefile.am
+++ zfs/etc/Makefile.am
@@ -55,6 +55,7 @@ systemdunit_DATA = \
 	%D%/systemd/system/zfs-import-cache.service \
 	%D%/systemd/system/zfs-import-scan.service \
 	%D%/systemd/system/zfs-import.target \
+	%D%/systemd/system/zfs-load-module.service \
 	%D%/systemd/system/zfs-mount.service \
 	%D%/systemd/system/zfs-scrub-monthly@.timer \
 	%D%/systemd/system/zfs-scrub-weekly@.timer \
Index: zfs/etc/systemd/system/zfs-import-cache.service.in
===================================================================
--- zfs.orig/etc/systemd/system/zfs-import-cache.service.in
+++ zfs/etc/systemd/system/zfs-import-cache.service.in
@@ -3,7 +3,9 @@ Description=Import ZFS pools by cache fi
 Documentation=man:zpool(8)
 DefaultDependencies=no
 Requires=systemd-udev-settle.service
+Requires=zfs-load-module.service
 After=systemd-udev-settle.service
+After=zfs-load-module.service
 After=cryptsetup.target
 After=multipathd.service
 After=systemd-remount-fs.service
Index: zfs/etc/systemd/system/zfs-import-scan.service.in
===================================================================
--- zfs.orig/etc/systemd/system/zfs-import-scan.service.in
+++ zfs/etc/systemd/system/zfs-import-scan.service.in
@@ -3,7 +3,9 @@ Description=Import ZFS pools by device s
 Documentation=man:zpool(8)
 DefaultDependencies=no
 Requires=systemd-udev-settle.service
+Requires=zfs-load-module.service
 After=systemd-udev-settle.service
+Requires=zfs-load-module.service
 After=cryptsetup.target
 After=multipathd.service
 Before=zfs-import.target
Index: zfs/etc/systemd/system/zfs-load-module.service.in
===================================================================
--- /dev/null
+++ zfs/etc/systemd/system/zfs-load-module.service.in
@@ -0,0 +1,17 @@
+[Unit]
+Description=Install ZFS kernel module
+DefaultDependencies=no
+Requires=systemd-udev-settle.service
+After=systemd-udev-settle.service
+After=cryptsetup.target
+Before=dracut-mount.service
+After=systemd-remount-fs.service
+
+[Service]
+Type=oneshot
+RemainAfterExit=yes
+ExecStart=/sbin/modprobe zfs
+
+[Install]
+WantedBy=zfs-mount.service
+WantedBy=zfs.target
Index: zfs/contrib/dracut/90zfs/module-setup.sh.in
===================================================================
--- zfs.orig/contrib/dracut/90zfs/module-setup.sh.in
+++ zfs/contrib/dracut/90zfs/module-setup.sh.in
@@ -95,7 +95,8 @@ install() {
 
 		for _service in \
 			"zfs-import-scan.service" \
-			"zfs-import-cache.service"; do
+			"zfs-import-cache.service" \
+            "zfs-load-module.service"; do
 			inst_simple "${systemdsystemunitdir}/${_service}"
 			systemctl -q --root "${initdir}" add-wants zfs-import.target "${_service}"
 
Index: zfs/etc/systemd/system/50-zfs.preset
===================================================================
--- zfs.orig/etc/systemd/system/50-zfs.preset
+++ zfs/etc/systemd/system/50-zfs.preset
@@ -2,6 +2,7 @@
 enable zfs-import-cache.service
 disable zfs-import-scan.service
 enable zfs-import.target
+enable zfs-load-module.service
 enable zfs-mount.service
 enable zfs-share.service
 enable zfs-zed.service
